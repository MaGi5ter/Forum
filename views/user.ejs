<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/style_user.css">
    <title>Gikam</title>
</head>
<body>
    <div id="container">

        <div id="navbar">

            <div id="buttons">
                <p onclick="overview_load()">OVERVIEW</p>
                <p onclick="posts_load()">POSTS</p>
                <p onclick="user_comments()">COMMENTS</p>

                <a href="/" id="a_log">HOME</a>
                <a href="/<%= link %>" id="a_log"><%= logged_status %></a>

            </div>

        </div>

        <div id="profile_data">

            <div id="overview">
                <!-- HERE ARE POSTS OF CERTAIN USER -->
            </div>

            <div id="account_info">

                <div id="account_background">
                    <img src="https://media.discordapp.net/attachments/773904529971871765/1084443708923056188/1Ep5kwsS4nQ.png">
                </div>

                <h2 id="username"><%= username %></h2>
    
            </div>

        </div>

        <br>

        <script>

        // <div id="post">
        //     <h2>Title</h2>
        //     <p>autghor</p>
        //     <p>Lorem ipsum rem ipsum Lorem ipsum Lorem ipsum Lorem ipsum</p>
        // </div>

            let selected = 'overview'
            let user = '<%= username %>';
            let last = 0

            start()
            async function start() {
                overview_load()
            }

            async function overview_load() {

                document.getElementById("overview").innerHTML = ''

                let user = '<%= username %>';
                let posts = await fetchdata(`/api/activity?user=${user}`)
                let comments = await fetchdata(`/api/usercomments?user=${user}`)

                let data = []

                for (let index = 0; index < posts.length; index++) {
                    const element = posts[index];
                    data.push(element)
                }

                for (let index = 0; index < comments.length; index++) {
                    const element = comments[index];
                    data.push(element)
                }

                data = await data.sort((a,b) => { return a.createdAt - b.createdAt })
                data.reverse()
                console.log(data)

                if(data.length == 0) {
                    let node = document.createElement("div");
                    node.id = 'post'

                    node.innerHTML = `
                        <h2>THIS USER NEVER POSTED ANYTHING</h2>
                    `
                    document.getElementById("overview").appendChild(node);
                    return
                }

                for (let index = 0; index < data.length; index++) {
                    const element = data[index];

                    let node = document.createElement("div");
                    node.id = 'post'

                    if(element.title) {
                        node.innerHTML = `
                            <h2>${element.title}</h2>
                            <p>${element.content}</p>
                        `
                        document.getElementById("overview").appendChild(node);
                        }
                    else {
                        let post_data = await fetchdata(`/api/post_data?id=${element.postID}`)

                        node.innerHTML = `
                            <p>commented <b><a id="basic_a" href="/post/${post_data[0].id}">${post_data[0].title}</a></b> posted by  <a id="basic_a" href="/user/${post_data[0].author}" >${post_data[0].author}</a></p>
                            <p>${element.content}</p>
                        `
                        document.getElementById("overview").appendChild(node);
                    }
                }
            }

            async function posts_load(){
                document.getElementById("overview").innerHTML = ''

                let user = '<%= username %>';
                let posts = await fetchdata(`/api/activity?user=${user}`)

                if(posts.length == 0) {
                    let node = document.createElement("div");
                    node.id = 'post'

                    node.innerHTML = `
                        <h2>THIS USER NEVER POSTED ANYTHING</h2>
                    `
                    document.getElementById("overview").appendChild(node);
                    return
                }

                for (let index = 0; index < posts.length; index++) {
                    const element = posts[index];

                    let node = document.createElement("div");
                    node.id = 'post'

                    node.innerHTML = `
                        <h2>${element.title}</h2>
                        <p>${element.content}</p>
                    `
                    document.getElementById("overview").appendChild(node);
                    console.log(element)
                }
            }

            async function user_comments() {
                let user = '<%= username %>';
                let comments = await fetchdata(`/api/usercomments?user=${user}`)

                document.getElementById("overview").innerHTML = ''

                if(comments.length == 0) {
                    let node = document.createElement("div");
                    node.id = 'post'

                    node.innerHTML = `
                        <h2>THIS USER NEVER COMMENTED ANYTHING</h2>
                    `
                    document.getElementById("overview").appendChild(node);
                    return
                }

                for (let index = 0; index < comments.length; index++) {
                    const element = comments[index];

                    let node = document.createElement("div");
                    node.id = 'post'

                    let post_data = await fetchdata(`/api/post_data?id=${element.postID}`)

                    node.innerHTML = `
                        <p>commented <b><a id="basic_a" href="/post/${post_data[0].id}">${post_data[0].title}</a></b> posted by  <a id="basic_a" href="/user/${post_data[0].author}" >${post_data[0].author}</a></p>
                        <p>${element.content}</p>
                    `
                    document.getElementById("overview").appendChild(node);
                    console.log(element)
                }

            }
            
            function fetchdata(url) {
                return new Promise((resolve,reject) => {
                fetch(url, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                    },
                }).then(response => {
                    return response.text();
                    }).then(function(data) {
                        resolve(JSON.parse(data)); 
                    });
                })
            }

        </script>

    </div>
</body>
</html>